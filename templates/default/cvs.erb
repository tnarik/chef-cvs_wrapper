# CVS WRAPPER TO USE WHEN REQUIRING THE USE OF A TUNNEL
function cvs() {
(
  # Extract CVSROOT with priorities
  # 1. -d
  DARG=`expr " $*" : '\ \(-d.*\)'`
  OPTIND=1
  FOUND_CVSROOT=""
  while getopts ":d:" opts $DARG; do
    case $opts in
      "d") FOUND_CVSROOT=$OPTARG
      ;;
    esac
  done

  # 2. CVS/Root
  if [ -z "$FOUND_CVSROOT" ]; then
    FOUND_CVSROOT=$(<CVS/Root)
  fi

  # 3. $CVSROOT
  if [ -z "$FOUND_CVSROOT" ]; then
    FOUND_CVSROOT=$CVSROOT
  fi

  TARGET=`expr "$FOUND_CVSROOT" : '.*@\([^/]*\)\/.*'`
  TARGET=${TARGET//:/_}

#echo "$TARGET" >> /tmp/targets_cvs
#echo "$*" >> /tmp/targets_cvs
 
  DIRECT_CONNECTION="true"
  TUNNEL_NAME=""
  TUNNEL_SLEEP=""

  source ~/.cvs_wrapper.d/${TARGET}
  if [ -n "$TARGET" ]; then
    echo "let's read a configuration/status file about $TARGET"

    DIRECT_CONNECTION=${DIRECT_CONNECTION}
    TUNNEL_NAME=${TUNNEL}
    TUNNEL_SLEEP=${SLEEP}
  fi

  if [ "$DIRECT_CONNECTION" == "true" ]; then
    #execute the real CVS
    command cvs "$@"
  else
    #execute CVS through an SSH tunnel
    ssh -f ${TUNNEL_NAME} sleep ${TUNNEL_SLEEP}
    command cvs "$@"
  fi
)
}